# can OTA κµ¬ν„

ECU : TMU, CGW, EDT

### OTA μ‹μ¤ν… λ³΄μ• μ„¤κ³„ μ”μ•½ (make\_bin\_file\_hybrid.py / app.py / download\_file.py)

---

## β… μ „μ²΄ μ‹μ¤ν… κ°μ”

μ΄ OTA μ‹μ¤ν…μ€ **ν•μ΄λΈλ¦¬λ“ μ•”νΈν™” (RSA + AES)**, **μ „μμ„λ…**, **SHA256 ν•΄μ‹**, **Nonce**, **νƒ€μ„μ¤νƒ¬ν”„** λ“±μ„ μ΅°ν•©ν•μ—¬ **κΈ°λ°€μ„±, λ¬΄κ²°μ„±, μΈμ¦, μµμ‹ μ„±**μ„ λ³΄μ¥ν•©λ‹λ‹¤.

---

## π“¦ 1. make\_bin\_file\_hybrid.py β€“ λ³΄μ• νμ›¨μ–΄ μƒμ„±

| μ£Όμ” μ—­ν•       | μ„¤λ…                                                                                |
| ---------- | --------------------------------------------------------------------------------- |
| νμ›¨μ–΄ λ΅λ“     | `firmware.bin` λ΅λ“                                                                 |
| ν‚¤ λ΅λ”©       | μ„λ²„ RSA κ°μΈν‚¤(μ„λ…μ©), μ°¨λ‰ RSA κ³µκ°ν‚¤(AES ν‚¤ μ•”νΈν™”μ©)                                           |
| SHA256 ν•΄μ‹  | νμ›¨μ–΄ μ½”λ“ ν•΄μ‹± β†’ ν—¤λ” ν¬ν•¨, μ„λ… λ€μƒ                                                          |
| μ „μμ„λ… μƒμ„±    | ν•΄μ‹μ— μ„λ²„ RSA κ°μΈν‚¤λ΅ μ„λ… (PKCS#1 v1.5)                                                  |
| AES λ€μΉ­ν‚¤ μƒμ„± | λ§¤λ² μƒλ΅μ΄ AES ν‚¤ λ° nonce μƒμ„±                                                           |
| νμ›¨μ–΄ μ•”νΈν™”    | AES CTR λ¨λ“λ΅ μ½”λ“ μ•”νΈν™”                                                                |
| AES ν‚¤ μ•”νΈν™”  | μ°¨λ‰ RSA κ³µκ°ν‚¤λ΅ μ•”νΈν™” (PKCS#1 OAEP)                                                     |
| ν—¤λ” κµ¬μ„±      | Magic, Timestamp, ECU ID, Version, Code Len, SHA256 ν•΄μ‹, AES Nonce ν¬ν•¨              |
| μµμΆ… νμΌ μƒμ„±   | header + enc\_aes\_key + signature + enc\_firmware β†’ `firmware_secure_hybrid.bin` |

### π”’ λ³΄μ• λ³΄μ¥ μ”μ†

* **κΈ°λ°€μ„±**: AES + RSA ν•μ΄λΈλ¦¬λ“ μ•”νΈν™”
* **λ¬΄κ²°μ„±**: SHA256 ν•΄μ‹ + μ „μμ„λ…
* **μΈμ¦**: μ„λ²„ κ°μΈν‚¤ κΈ°λ° μ„λ…
* **μµμ‹ μ„±**: νƒ€μ„μ¤νƒ¬ν”„ ν¬ν•¨

---

## π 2. app.py β€“ OTA μ„λ²„ (Flask κΈ°λ°)

| κΈ°λ¥ λ¶„λ¥     | μ„¤λ…                                                          |
| --------- | ----------------------------------------------------------- |
| μ›Ή μ„λ²„ κµ¬ν„   | Flask κΈ°λ° API: μ—…λ΅λ“/λ‹¤μ΄λ΅λ“/λ²„μ „ λ³΄κ³  λ“± μ κ³µ                           |
| κ΄€λ¦¬μ μΈμ¦    | `/login`, `/upload_firmware`, `/vehicles`, `/users`λ” λ΅κ·ΈμΈ ν•„μ” |
| νμ›¨μ–΄ μ—…λ΅λ“   | `firmware.bin` μ—…λ΅λ“ β†’ λ³΄μ• μ²λ¦¬ λ€μƒ                               |
| μµμ‹  μ •λ³΄ μ κ³µ  | `/latest_version`: μµμ‹  λ²„μ „λ…, SHA256 ν•΄μ‹ μ κ³µ                     |
| nonce λ°κΈ‰  | `/get_nonce`: 1νμ© λ‚μ λ°κΈ‰ β†’ μ¬μ‚¬μ© κ³µκ²© λ°©μ§€                         |
| λ‹¤μ΄λ΅λ“ μ κ³µ   | `/ota_download/<filename>`: nonce + ν† ν° ν•„μ”                   |
| ECU λ²„μ „ λ³΄κ³  | `/report_versions`: μ°¨λ‰ ν† ν° κΈ°λ°, versions.json μ €μ¥              |
| λ³΄μ• λ΅κΉ…     | `audit.log`μ— λ΅κ·ΈμΈ, λ‹¤μ΄λ΅λ“, λ³΄κ³  κΈ°λ΅ μ €μ¥                            |

### π” λ³΄μ• λ³΄μ¥ μ”μ†

* **μΈμ¦**: μ°¨λ‰ ν† ν° + κ΄€λ¦¬μ λ΅κ·ΈμΈ
* **μµμ‹ μ„±**: nonce κΈ°λ° λ‹¤μ΄λ΅λ“ μ”μ²­
* **λ¬΄κ²°μ„± λ³΄μ΅°**: SHA256 ν•΄μ‹ μ κ³µ
* **κ°μ‚¬ κ°€λ¥μ„±**: λ΅κ·Έ κΈ°λ΅

---

## π— 3. download\_file.py β€“ OTA ν΄λΌμ΄μ–ΈνΈ

| κΈ°λ¥ λ¶„λ¥      | μ„¤λ…                                                                  |
| ---------- | ------------------------------------------------------------------- |
| μ„λ²„ ν†µμ‹       | `latest_version`, `get_nonce`, `ota_download`, `report_versions` μ”μ²­ |
| ν‚¤ λ΅λ”©       | μ°¨λ‰ RSA κ°μΈν‚¤, μ„λ²„ RSA κ³µκ°ν‚¤ λ΅λ”©                                           |
| νμ›¨μ–΄ λ‹¤μ΄λ΅λ“   | nonce ν¬ν•¨λ μ”μ²­ β†’ firmware\_secure\_hybrid.bin μμ‹                       |
| λ¬΄κ²°μ„± ν™•μΈ (1) | λ‹¤μ΄λ΅λ“ μ™„λ£ ν›„ SHA256 β†’ μ„λ²„ μ κ³µ ν•΄μ‹μ™€ λΉ„κµ                                     |
| νμΌ νμ‹±      | header λ¶„μ„ β†’ Magic, Timestamp, ECU ID, Version, λ“± μ¶”μ¶                 |
| μµμ‹ μ„± ν™•μΈ     | νƒ€μ„μ¤νƒ¬ν”„κ°€ 30μΌ μ΄λ‚΄μΈμ§€ ν™•μΈ                                                  |
| AES ν‚¤ λ³µνΈν™”  | μ°¨λ‰ κ°μΈν‚¤λ΅ μ•”νΈν™”λ AES ν‚¤ λ³µνΈν™”                                              |
| νμ›¨μ–΄ λ³µνΈν™”    | AES ν‚¤ + nonceλ΅ μ›λ³Έ λ³µμ›                                                |
| λ¬΄κ²°μ„± ν™•μΈ (2) | λ³µνΈν™”λ μ½”λ“μ SHA256κ³Ό ν—¤λ” ν•΄μ‹ λΉ„κµ                                           |
| μ „μμ„λ… κ²€μ¦    | ν•΄μ‹ + μ „μμ„λ… β†’ μ„λ²„ κ³µκ°ν‚¤λ΅ κ²€μ¦                                              |
| CANoe μ—°λ™   | μ‹μ¤ν… λ³€μ μ„¤μ • β†’ μ‚¬μ©μ μΉμΈ / κ²°κ³Ό ν™•μΈ / ECU λ²„μ „ μ΅°ν                              |
| μ„λ²„μ— λ³΄κ³      | OTA μ™„λ£ ν›„ ECU λ²„μ „ μ •λ³΄λ¥Ό λ‹¤μ‹ μ „μ†΅                                           |

### π”’ λ³΄μ• λ³΄μ¥ μ”μ†

* **κΈ°λ°€μ„±**: λ³µνΈν™” μ‹μ—λ§ μ›λ³Έ ν™•μΈ κ°€λ¥ (RSA + AES)
* **λ¬΄κ²°μ„±**: 2λ‹¨κ³„ SHA256 ν•΄μ‹ ν™•μΈ
* **μΈμ¦**: μ„λ²„ μ„λ… κ²€μ¦
* **μµμ‹ μ„±**: νƒ€μ„μ¤νƒ¬ν”„ μ ν¨μ„± κ²€μ‚¬
* **μ¬μ‚¬μ© λ°©μ§€**: nonce μ‚¬μ©

---

## π” μ „μ²΄ λ³΄μ• νλ¦„ μ”μ•½

| λ‹¨κ³„         | μ μ© λ³΄μ• μ”μ†                                                 |
| ---------- | -------------------------------------------------------- |
| μƒμ„± (μ„λ²„)    | μΈμ¦(μ„λ…), κΈ°λ°€μ„±(RSA+AES), λ¬΄κ²°μ„±(SHA256), μµμ‹ μ„±(νƒ€μ„μ¤νƒ¬ν”„)            |
| λ°°ν¬ (μ„λ²„)    | μΈμ¦(ν† ν°), μ¬μ‚¬μ© λ°©μ§€(nonce), λ¬΄κ²°μ„± κ²€μ¦μ© ν•΄μ‹, λ΅κ·Έ κΈ°λ΅                 |
| μ„¤μΉ (ν΄λΌμ΄μ–ΈνΈ) | κΈ°λ°€μ„±(AES λ³µνΈν™”), λ¬΄κ²°μ„±(SHA256x2), μΈμ¦(μ„λ… κ²€μ¦), μµμ‹ μ„± κ²€μ‚¬, nonce μ‚¬μ© |

---

## System Variable

| NameSpace        | Name      | Detail      | 
| ---------- | ------------------------ |------------------------ |
| CAR    | addSpeed            | κ°€μ†λ„           |
| CAR    | Distance            | μ•μ°¨μ™€μ κ±°λ¦¬    |
| CAR    | vehSpeed            | μ°¨λ‰ μ†λ„        |
| CAR    | acc            | μ—‘μ…€ on/off        |
| CAR    | brake            | λΈλ μ΄ν¬  on/off        |
| OTA    | Cur_version[]             | ecuλ“¤μ ν„μ¬ λ²„μ „        |
| OTA    | Next_version[]            | ecuλ“¤μ μ—…λ°μ΄νΈ λ  λ²„μ „        |
| OTA    | ECU_id            | target ecu id        |
| OTA    | ECU_ver            | target ecu version        |
| OTA    | Ota_flag            | ota μΉμΈ, κ±°μ  μ§„ν–‰λ“± ota μƒνƒ        |
| OTA    | Version_num[]            | 1~10κΉμ§€μ λ²„μ „ μ •λ³΄        |
| OTA    | OTA_UserSelect            | μΉμΈ/κ±°μ  μ…λ ¥        |
| OTA    | Progress            | νμΌ λ‹¤μ΄λ΅λ“ μ§„ν–‰λ¥         |



